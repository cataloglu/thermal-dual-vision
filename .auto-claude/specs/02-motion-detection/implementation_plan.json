{
  "feature": "02 - Motion Detection",
  "workflow_type": "feature",
  "workflow_rationale": "New module development requiring RTSP camera connection, OpenCV motion detection algorithm, and thread-safe callback system. Feature workflow ensures proper dependency order: connection -> algorithm -> threading -> lifecycle.",
  "phases": [
    {
      "id": "phase-1-camera-connection",
      "name": "Camera Connection",
      "type": "implementation",
      "description": "Establish RTSP stream connection using OpenCV VideoCapture with retry and timeout logic",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create MotionDetector class skeleton with __init__, basic properties, and VideoCapture setup",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/motion_detector.py"
          ],
          "patterns_from": [
            "src/config.py",
            "src/logger.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.motion_detector import MotionDetector; from src.config import CameraConfig, MotionConfig; md = MotionDetector(CameraConfig(), MotionConfig()); print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Successfully created MotionDetector class skeleton with __init__, basic properties (is_running, get_frame), VideoCapture setup placeholder, and thread management. Verification passed. Follows patterns from config.py and logger.py.",
          "updated_at": "2026-01-16T00:52:27.362917+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Implement RTSP connection logic with cv2.VideoCapture including connection timeout handling",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/logger.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Verify VideoCapture initialization with proper timeout and error handling"
          },
          "status": "completed",
          "notes": "Implemented RTSP connection logic with cv2.VideoCapture including:\n- Connection timeout handling (10s open timeout, 5s read timeout)\n- Connection validation via test frame reading\n- Proper error handling and resource cleanup\n- Public connect()/disconnect() methods and is_connected property\n- Comprehensive logging and error messages",
          "updated_at": "2026-01-16T00:53:42.934082+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Add connection retry mechanism with exponential backoff (max 3 attempts, configurable delays)",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Verify retry logic with backoff, max attempts, and proper logging"
          },
          "status": "completed",
          "notes": "Added retry mechanism with exponential backoff to MotionDetector.connect(). Configuration includes retry_max_attempts (default 3), retry_initial_delay (default 1.0s), and retry_backoff (default 2.0x). Extracted connection logic to _attempt_connection() method. Added proper logging for each attempt and retry delays.",
          "updated_at": "2026-01-16T00:55:00.090570+00:00"
        }
      ]
    },
    {
      "id": "phase-2-motion-algorithm",
      "name": "Motion Detection Algorithm",
      "type": "implementation",
      "description": "Implement background subtraction using MOG2, contour detection, and sensitivity-based filtering",
      "depends_on": [
        "phase-1-camera-connection"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Initialize cv2.createBackgroundSubtractorMOG2 with appropriate parameters",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: BackgroundSubtractorMOG2 created with sensible defaults"
          },
          "status": "completed",
          "notes": "Successfully initialized cv2.createBackgroundSubtractorMOG2 with appropriate parameters. Parameters set: history=500 (frames for background model), varThreshold=16 (pixel-model match threshold), detectShadows=True (reduces false positives). Implementation includes clear comments explaining each parameter's purpose and rationale.",
          "updated_at": "2026-01-16T00:56:18.581942+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Implement contour detection logic with cv2.findContours and area calculation",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Contour detection with proper morphological operations and area filtering"
          },
          "status": "completed",
          "notes": "Successfully implemented contour detection logic with cv2.findContours and area calculation. Implementation includes:\n- Background subtraction using MOG2 algorithm\n- Morphological operations (erosion + dilation with elliptical kernel) to reduce noise\n- Contour detection with cv2.findContours using RETR_EXTERNAL and CHAIN_APPROX_SIMPLE\n- Area-based filtering using min_area from config\n- Debug logging for motion detection events\nCode review verified: proper morphological operations and area filtering in place.",
          "updated_at": "2026-01-16T00:57:21.374031+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Map sensitivity (1-10) to MOG2 threshold and min_area parameters",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Sensitivity mapping function with clear documentation"
          },
          "status": "completed",
          "notes": "Implemented map_sensitivity_to_params() function that maps sensitivity (1-10) to MOG2 varThreshold (8-50) and min_area (100-2000) parameters. Updated MotionDetector.__init__ to use the mapping function. Includes comprehensive documentation and input validation.",
          "updated_at": "2026-01-16T00:59:11.821610+00:00"
        }
      ]
    },
    {
      "id": "phase-3-threading-callbacks",
      "name": "Threading & Callbacks",
      "type": "implementation",
      "description": "Build thread-safe frame capture loop, callback system, and cooldown timer",
      "depends_on": [
        "phase-2-motion-algorithm"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Create frame capture thread with continuous loop reading from VideoCapture",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Threading.Thread with proper daemon flag and loop logic"
          },
          "status": "completed",
          "notes": "Successfully implemented _capture_loop() method for continuous frame capture in background thread. Implementation includes:\n- Continuous while loop controlled by _running flag\n- Reads frames from VideoCapture at configured FPS (calculated frame_delay)\n- Thread-safe frame storage using threading.Lock (self._lock)\n- Integrated motion detection using _detect_motion() on each frame\n- Automatic reconnection handling if camera disconnects\n- Proper error handling with try/except and detailed logging\n- FPS timing control with time.sleep(frame_delay)\n- Placeholder for callback invocation (will be implemented in subtask-3-2 and 3-3)\n\nCode review verified: Threading.Thread compatible method with proper daemon flag support and loop logic. Ready for integration with start/stop lifecycle methods in phase 4.",
          "updated_at": "2026-01-16T01:00:49.946778+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Implement thread-safe callback registration system with on_motion(callback) method",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Thread-safe callback storage (Lock) and invocation"
          },
          "status": "completed",
          "notes": "Implemented thread-safe callback registration with on_motion(callback) method. Uses threading.Lock for safe concurrent access to callbacks list. Includes comprehensive documentation and debug logging.",
          "updated_at": "2026-01-16T01:01:55.853734+00:00"
        },
        {
          "id": "subtask-3-3",
          "description": "Add cooldown timer to prevent callback spam (using last_motion_time + cooldown_seconds check)",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Cooldown logic with time.time() comparison"
          },
          "status": "completed",
          "notes": "Successfully implemented cooldown timer to prevent callback spam. Implementation includes:\n- Added _last_motion_time attribute initialized to 0.0 to track when motion was last detected\n- In capture loop, check if time.time() - _last_motion_time >= cooldown_seconds before invoking callbacks\n- Only invoke callbacks if cooldown period has passed\n- Update _last_motion_time after invoking callbacks\n- Added debug logging for cooldown status (both when passed and when still active)\n- Thread-safe callback copying and invocation with error handling\nCode review verified: Proper cooldown logic with time.time() comparison as specified.",
          "updated_at": "2026-01-16T01:03:04.050154+00:00"
        }
      ]
    },
    {
      "id": "phase-4-lifecycle",
      "name": "Lifecycle Management",
      "type": "implementation",
      "description": "Implement start/stop methods, graceful shutdown, and proper resource cleanup",
      "depends_on": [
        "phase-3-threading-callbacks"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Implement start() method to launch capture thread and initialize resources",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/logger.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Code review: start() method initializes thread and sets running flag"
          },
          "status": "completed",
          "notes": "Implemented start() method that initializes and launches the capture thread with proper thread safety, error handling, and logging. Thread runs as daemon with _capture_loop as target.",
          "updated_at": "2026-01-16T01:03:59.912060+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Implement stop() method with thread join and resource cleanup",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: stop() sets running=False, joins thread, releases VideoCapture"
          },
          "status": "completed",
          "notes": "Implemented stop() method with graceful thread shutdown, resource cleanup, and proper thread safety. Method sets _running=False, joins thread with timeout, releases VideoCapture, and cleans up thread reference. Follows existing code patterns and includes comprehensive docstring.",
          "updated_at": "2026-01-16T01:05:06.483172+00:00"
        },
        {
          "id": "subtask-4-3",
          "description": "Add is_running() property and get_frame() method for external frame access",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.motion_detector import MotionDetector; from src.config import CameraConfig, MotionConfig; md = MotionDetector(CameraConfig(), MotionConfig()); print('is_running' in dir(md) and 'get_frame' in dir(md))\"",
            "expected": "True"
          },
          "status": "pending"
        },
        {
          "id": "subtask-4-4",
          "description": "Add __enter__ and __exit__ for context manager support (with statement)",
          "service": "backend",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Code review: Context manager methods call start() and stop()"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-5-testing",
      "name": "Testing & Verification",
      "type": "integration",
      "description": "Create unit tests with mock camera and integration tests for verification",
      "depends_on": [
        "phase-4-lifecycle"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create unit test file tests/test_motion_detector.py with mock VideoCapture",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "tests/test_motion_detector.py"
          ],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "python -c \"import os; print('OK' if os.path.exists('tests/test_motion_detector.py') else 'FAIL')\"",
            "expected": "OK"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Write unit tests for lifecycle methods (start, stop, is_running)",
          "service": "backend",
          "files_to_modify": [
            "tests/test_motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_motion_detector.py -v -k lifecycle",
            "expected": "All tests pass"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "Write unit tests for callback mechanism and cooldown timer",
          "service": "backend",
          "files_to_modify": [
            "tests/test_motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_motion_detector.py -v -k callback",
            "expected": "All tests pass"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-4",
          "description": "Write unit tests for sensitivity parameter and motion detection logic",
          "service": "backend",
          "files_to_modify": [
            "tests/test_motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_motion_detector.py -v -k sensitivity",
            "expected": "All tests pass"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-5",
          "description": "Run full test suite and verify all tests pass",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/ -v --tb=short",
            "expected": "All tests pass"
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 17,
    "services_involved": [
      "backend"
    ],
    "parallelism": {
      "max_parallel_phases": 1,
      "parallel_groups": [],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution required due to dependencies",
      "rationale": "Each phase builds upon the previous: connection -> algorithm -> threading -> lifecycle -> testing. No parallel opportunities."
    },
    "startup_command": "python -m src.main"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "RTSP stream connection works with retry logic",
      "Motion detection triggers callback when motion detected",
      "Sensitivity parameter correctly adjusts detection threshold",
      "Cooldown timer prevents callback spam",
      "Frame capture maintains >= 5 FPS performance",
      "Graceful shutdown releases all resources",
      "All unit tests pass",
      "Memory leak check passes (verify with longer run)"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "pytest tests/ -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Mock Camera Test",
        "command": "pytest tests/test_motion_detector.py -v -k mock",
        "expected_outcome": "Mock camera simulation passes",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Code Quality",
        "command": "ruff check src/motion_detector.py",
        "expected_outcome": "No linting errors",
        "type": "lint",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk: Threading complexity, external RTSP connection, real-time performance requirements. Requires thorough unit testing with mocked camera and integration testing with real stream. Memory leak monitoring recommended for production deployment."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest tests/test_motion_detector.py -v"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "pytest tests/ -v --integration"
      ],
      "services_to_test": [
        "motion_detector"
      ],
      "manual_steps": [
        "Test with real RTSP stream (provide test URL)",
        "Monitor memory usage for 1 hour continuous operation",
        "Verify FPS >= 5 with logging output"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "performance_verification": {
      "required": true,
      "checks": [
        "Frame capture rate >= 5 FPS",
        "Memory usage stable over 1 hour",
        "CPU usage reasonable for continuous video processing"
      ]
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-16T01:05:30.413Z",
  "last_updated": "2026-01-16T01:05:06.483182+00:00"
}