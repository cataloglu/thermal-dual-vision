{
  "feature": "07 - Telegram Bot Integration",
  "workflow_type": "feature",
  "workflow_rationale": "New module development with multiple implementation phases. The Telegram bot requires bot setup, command handling, alert system, and integration testing in sequence.",
  "phases": [
    {
      "id": "phase-1-bot-setup",
      "name": "Bot Setup & Lifecycle",
      "type": "implementation",
      "description": "Create TelegramBot class with Application setup, lifecycle management, and authorization middleware",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Update TelegramConfig to support chat_ids list",
          "service": "backend",
          "files_to_modify": [
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.config import TelegramConfig; cfg = TelegramConfig(chat_ids=['123']); assert hasattr(cfg, 'chat_ids'); print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Updated TelegramConfig to use chat_ids list instead of single chat_id. Updated from_env to parse comma-separated chat IDs and validate to check for non-empty list.",
          "updated_at": "2026-01-16T06:49:19.186698+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Create TelegramBot class with __init__ and Application setup",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "src/telegram_bot.py"
          ],
          "patterns_from": [
            "src/config.py",
            "src/logger.py",
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.telegram_bot import TelegramBot; from src.config import TelegramConfig; cfg = TelegramConfig(bot_token='test', chat_ids=['123']); bot = TelegramBot(cfg); print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created TelegramBot class with __init__ method and Application setup. Implementation includes graceful handling of missing python-telegram-bot dependency. Application is built using telegram.ext.Application.builder() pattern. Follows coding patterns from logger.py and config.py. Verification passes successfully.",
          "updated_at": "2026-01-16T06:51:11.965233+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Implement async start() and stop() lifecycle methods",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"import asyncio; from src.telegram_bot import TelegramBot; from src.config import TelegramConfig; cfg = TelegramConfig(bot_token='test', chat_ids=['123']); bot = TelegramBot(cfg); assert hasattr(bot, 'start'); assert hasattr(bot, 'stop'); print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Implemented async start() and stop() lifecycle methods with proper error handling and logging. Methods initialize/start and stop/shutdown the Telegram Application gracefully.",
          "updated_at": "2026-01-16T06:52:19.116465+00:00"
        },
        {
          "id": "subtask-1-4",
          "description": "Add chat ID authorization middleware",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review telegram_bot.py and verify _check_authorization() method exists and validates chat_id against config.chat_ids list"
          },
          "status": "completed",
          "notes": "Added _check_authorization() method to TelegramBot class. Method validates chat_id against config.chat_ids list, converts int chat_id to string for comparison, logs warnings for unauthorized access, and handles empty chat_ids configuration. Follows code patterns from config.py with comprehensive docstrings and type hints.",
          "updated_at": "2026-01-16T06:53:20.756703+00:00"
        }
      ]
    },
    {
      "id": "phase-2-commands",
      "name": "Command Handlers",
      "type": "implementation",
      "description": "Implement all bot commands: /status, /arm, /disarm, /snapshot, /help",
      "depends_on": [
        "phase-1-bot-setup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Implement /help command handler",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review _handle_help() method and verify it returns formatted help text with all available commands"
          },
          "status": "completed",
          "notes": "Implemented _handle_help() method that returns formatted help text with all available commands (/status, /arm, /disarm, /snapshot, /help). Uses emojis and Turkish text matching spec style. Follows existing code patterns with proper docstring and type hints.",
          "updated_at": "2026-01-16T06:54:51.478700+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Implement /status command handler",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review _handle_status() method and verify it reports armed state, last detection time, and uptime"
          },
          "status": "completed",
          "notes": "Implemented _handle_status() method that reports armed state, last detection time, and uptime. Added state tracking variables (_armed, _last_detection_time, _start_time) to TelegramBot.__init__. Method formats status with Turkish text and emojis, showing armed state (Aktif/Pasif), last detection timestamp or \"Henüz algılama yok\", and uptime in days/hours/minutes/seconds. Follows code patterns with proper docstring and type hints. Verification passed successfully.",
          "updated_at": "2026-01-16T06:56:23.701099+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Implement /arm and /disarm command handlers with callbacks",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review _handle_arm() and _handle_disarm() methods. Verify set_arm_callback() and set_disarm_callback() methods exist and are called when commands are executed"
          },
          "status": "completed",
          "notes": "Implemented _handle_arm() and _handle_disarm() methods with proper state management. Added set_arm_callback() and set_disarm_callback() methods for registering callbacks. Includes error handling and Turkish messaging consistent with existing code patterns.",
          "updated_at": "2026-01-16T06:57:30.905735+00:00"
        },
        {
          "id": "subtask-2-4",
          "description": "Implement /snapshot command handler with callback",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review _handle_snapshot() method. Verify set_snapshot_callback() method exists and snapshot is requested and sent when command is executed"
          },
          "status": "completed",
          "notes": "Implemented /snapshot command handler with callback. Added _snapshot_callback attribute, _handle_snapshot() method with error handling, and set_snapshot_callback() method following existing patterns from arm/disarm commands.",
          "updated_at": "2026-01-16T06:58:36.658335+00:00"
        },
        {
          "id": "subtask-2-5",
          "description": "Register all command handlers with Application",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review start() method and verify all command handlers are registered via application.add_handler(CommandHandler(...))"
          },
          "status": "completed",
          "notes": "Registered all command handlers with Application. Added async command wrapper methods (_cmd_help, _cmd_status, _cmd_arm, _cmd_disarm, _cmd_snapshot) that check authorization and call handler methods. Imported Update, CommandHandler, and ContextTypes from telegram.ext. All five command handlers are registered in start() method via application.add_handler(). Each wrapper checks authorization before processing and returns appropriate messages.",
          "updated_at": "2026-01-16T06:59:59.287189+00:00"
        }
      ]
    },
    {
      "id": "phase-3-alerts",
      "name": "Alert System",
      "type": "implementation",
      "description": "Implement motion detection alert notifications with images and rate limiting",
      "depends_on": [
        "phase-1-bot-setup"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Implement send_message() method",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review send_message() method and verify it sends text messages to all configured chat_ids"
          },
          "status": "completed",
          "notes": "Implemented send_message() method that sends text messages to all configured chat_ids with proper error handling, logging, and Markdown support",
          "updated_at": "2026-01-16T07:01:25.412525+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Create format_alert_message() to format detection alerts",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review _format_alert_message() method and verify it formats alert with emoji, timestamp, threat level, confidence, analysis text, and detected objects"
          },
          "status": "completed",
          "notes": "Implemented _format_alert_message() method that formats detection alerts with emoji, timestamp, threat level (converted from Turkish lowercase to capitalized), confidence percentage, detailed analysis text, and detected objects. Method uses ScreenshotSet.timestamp and AnalysisResult fields (tehdit_seviyesi, guven_skoru, detayli_analiz, tespit_edilen_nesneler). Added TYPE_CHECKING import for forward references to AnalysisResult and ScreenshotSet. Fixed ContextTypes.DEFAULT_TYPE type hint issue when telegram is not installed by creating mock class. Verification passes successfully with sample data showing correct formatting matching spec.",
          "updated_at": "2026-01-16T07:04:28.275519+00:00"
        },
        {
          "id": "subtask-3-3",
          "description": "Implement send_alert() with media group (3 images)",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review send_alert() method and verify it sends formatted alert message plus 3 images as InputMediaPhoto media group"
          },
          "status": "completed",
          "notes": "Implemented send_alert() method that sends motion detection alerts with 3 images as media group. Added InputMediaPhoto import, encode_frame_to_bytes import from utils. Method converts 3 frames (before, now, after) to JPEG bytes, creates InputMediaPhoto media group with alert message as caption on first photo, and sends to all configured chat IDs with proper error handling and logging.",
          "updated_at": "2026-01-16T07:06:21.000944+00:00"
        },
        {
          "id": "subtask-3-4",
          "description": "Integrate RateLimiter for alert rate limiting",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review send_alert() and verify it uses RateLimiter from utils.py to enforce rate_limit_seconds from config"
          },
          "status": "completed",
          "notes": "Integrated RateLimiter from utils.py to enforce rate_limit_seconds from config. Rate limiter initialized in __init__ and applied to send_alert() using async context manager. Ensures minimum interval between alert sends.",
          "updated_at": "2026-01-16T07:07:42.686348+00:00"
        }
      ]
    },
    {
      "id": "phase-4-error-handling",
      "name": "Error Handling & Resilience",
      "type": "implementation",
      "description": "Add comprehensive error handling and retry logic for network issues",
      "depends_on": [
        "phase-2-commands",
        "phase-3-alerts"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Add error handling to all command handlers",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review all command handlers and verify they have try/except blocks that catch and log exceptions"
          },
          "status": "completed",
          "notes": "Added comprehensive error handling to all 5 command handlers (_cmd_help, _cmd_status, _cmd_arm, _cmd_disarm, _cmd_snapshot). Each handler now wraps its logic in try/except blocks that catch exceptions, log errors using self.logger.error(), and send user-friendly error messages in Turkish to the user. Includes nested try/except around error message sending to handle cases where sending the error message itself might fail. Follows error handling patterns from utils.py and existing code in send_message/send_alert methods.",
          "updated_at": "2026-01-16T07:09:17.911178+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Add @retry_async decorator to network methods",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "manual",
            "instructions": "Review send_alert() and send_message() methods and verify they use @retry_async decorator for automatic retries"
          },
          "status": "completed",
          "notes": "Added @retry_async decorator to send_message() and send_alert() network methods with default parameters (max_attempts=3, delay=1.0, backoff=2.0) for automatic retry on network failures",
          "updated_at": "2026-01-16T07:10:39.100863+00:00"
        },
        {
          "id": "subtask-4-3",
          "description": "Add error callback for Application",
          "service": "backend",
          "files_to_modify": [
            "src/telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "manual",
            "instructions": "Review start() method and verify application.add_error_handler() is called to log uncaught errors"
          },
          "status": "completed",
          "notes": "Added async _error_handler() method to handle uncaught errors from the Telegram bot. Registered error handler in start() method using application.add_error_handler(). Handler logs all uncaught exceptions using self.logger.error() with exc_info for full stack traces. Follows error handling patterns from existing codebase.",
          "updated_at": "2026-01-16T07:12:15.734139+00:00"
        }
      ]
    },
    {
      "id": "phase-5-testing",
      "name": "Unit Testing",
      "type": "implementation",
      "description": "Create unit tests for bot functionality with mocked Telegram API",
      "depends_on": [
        "phase-4-error-handling"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Create test_telegram_bot.py with test setup",
          "service": "backend",
          "files_to_modify": [],
          "files_to_create": [
            "tests/test_telegram_bot.py"
          ],
          "patterns_from": [
            "tests/__init__.py"
          ],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_telegram_bot.py -v --tb=short -k 'test_bot' || echo 'Tests not yet passing'",
            "expected": "Tests not yet passing or passing"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-2",
          "description": "Add tests for authorization (chat_ids whitelist)",
          "service": "backend",
          "files_to_modify": [
            "tests/test_telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_telegram_bot.py::test_authorization -v",
            "expected": "PASSED"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-3",
          "description": "Add tests for command handlers",
          "service": "backend",
          "files_to_modify": [
            "tests/test_telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_telegram_bot.py::test_commands -v",
            "expected": "PASSED"
          },
          "status": "pending"
        },
        {
          "id": "subtask-5-4",
          "description": "Add tests for alert formatting and rate limiting",
          "service": "backend",
          "files_to_modify": [
            "tests/test_telegram_bot.py"
          ],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "command",
            "command": "pytest tests/test_telegram_bot.py::test_alerts -v",
            "expected": "PASSED"
          },
          "status": "pending"
        }
      ]
    },
    {
      "id": "phase-6-integration",
      "name": "Integration Verification",
      "type": "integration",
      "description": "Manual integration testing with real bot to verify all functionality",
      "depends_on": [
        "phase-5-testing"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-6-1",
          "description": "End-to-end verification of bot functionality",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Set TELEGRAM_BOT_TOKEN and TELEGRAM_CHAT_IDS in environment",
              "Start bot with real token",
              "Send /help command and verify response",
              "Send /status command and verify response",
              "Test /arm and /disarm commands",
              "Test /snapshot command",
              "Verify unauthorized chat is rejected",
              "Trigger mock alert and verify message + 3 images received",
              "Verify rate limiting prevents spam"
            ]
          },
          "status": "pending"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 6,
    "total_subtasks": 20,
    "services_involved": [
      "backend"
    ],
    "parallelism": {
      "max_parallel_phases": 2,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-commands",
            "phase-3-alerts"
          ],
          "reason": "Both depend only on phase-1-bot-setup and work on different aspects of the bot"
        }
      ],
      "recommended_workers": 1,
      "speedup_estimate": "Sequential execution recommended due to shared file modifications"
    },
    "startup_command": "python src/telegram_bot.py"
  },
  "verification_strategy": {
    "risk_level": "medium",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "Bot starts successfully and connects to Telegram",
      "All command handlers respond correctly",
      "Alert messages sent with 3 images as media group",
      "Rate limiting prevents message spam",
      "Unauthorized chat IDs are rejected",
      "All unit tests pass",
      "Integration test with real bot succeeds"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "pytest tests/test_telegram_bot.py -v",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Import Check",
        "command": "python -c 'from src.telegram_bot import TelegramBot; print(\"OK\")'",
        "expected_outcome": "OK",
        "type": "command",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Test",
        "command": "Manual testing with real Telegram bot token",
        "expected_outcome": "All commands work, alerts sent successfully",
        "type": "manual",
        "required": true,
        "blocking": false
      }
    ],
    "reasoning": "Medium risk change requires unit tests for command handling and authorization, plus integration tests with real bot for end-to-end verification"
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest tests/test_telegram_bot.py -v"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "Manual testing with real bot"
      ],
      "services_to_test": [
        "backend"
      ]
    },
    "e2e_tests": {
      "required": true,
      "commands": [
        "Manual E2E test"
      ],
      "flows": [
        "bot-commands",
        "alert-notifications",
        "authorization"
      ]
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-16T07:12:35.700Z",
  "last_updated": "2026-01-16T07:12:15.734165+00:00"
}