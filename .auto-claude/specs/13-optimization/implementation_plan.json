{
  "feature": "Performance Optimization & Resource Management",
  "workflow_type": "refactor",
  "workflow_rationale": "This is a performance improvement task that requires measuring baseline, adding optimizations alongside existing code, validating improvements, and ensuring no regressions. The refactor workflow ensures we can measure impact at each stage.",
  "phases": [
    {
      "id": "phase-1-measure",
      "name": "Baseline Measurement & Metrics",
      "type": "setup",
      "description": "Create performance monitoring system and establish baseline metrics before optimization",
      "depends_on": [],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-1-1",
          "description": "Create metrics.py module with PerformanceMetrics dataclass",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/metrics.py"
          ],
          "patterns_from": [
            "src/config.py",
            "src/llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.metrics import PerformanceMetrics, MetricsCollector; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/metrics.py with PerformanceMetrics dataclass (fps, memory_mb, cpu_percent, inference_ms, queue_size, uptime_seconds) and MetricsCollector class with psutil integration. Includes methods for tracking frames (FPS), inference timing, queue size, memory usage, CPU usage, and uptime. Verification passes successfully.",
          "updated_at": "2026-01-16T13:28:26.105285+00:00"
        },
        {
          "id": "subtask-1-2",
          "description": "Add metrics collection to existing modules",
          "service": "main",
          "files_to_modify": [
            "src/llm_analyzer.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'MetricsCollector\\|processing_time' src/llm_analyzer.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added MetricsCollector integration to LLMAnalyzer. Imported MetricsCollector, added optional metrics_collector parameter to __init__, and added metric recording after processing_time calculation. Converts time to milliseconds. Verification passes. Commit: 802e0fe",
          "updated_at": "2026-01-16T13:30:18.911544+00:00"
        },
        {
          "id": "subtask-1-3",
          "description": "Create health metrics HTTP endpoint",
          "service": "main",
          "files_to_modify": [],
          "files_to_create": [
            "src/health_endpoint.py"
          ],
          "patterns_from": [
            "src/llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -c \"from src.health_endpoint import HealthEndpoint; print('OK')\"",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/health_endpoint.py with HealthEndpoint class. Aiohttp server on port 8099 exposing /health (status, uptime) and /metrics (fps, memory_mb, cpu_percent, inference_ms, queue_size, uptime_seconds) endpoints with JSON responses. Includes async start/stop methods, proper error handling and logging. Verification passes. Commit: 28d115f",
          "updated_at": "2026-01-16T13:32:44.652685+00:00"
        }
      ]
    },
    {
      "id": "phase-2-memory",
      "name": "Memory Optimization",
      "type": "implementation",
      "description": "Optimize memory usage: ring buffer sizing, JPEG compression, frame resizing, numpy array reuse",
      "depends_on": [
        "phase-1-measure"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-2-1",
          "description": "Optimize ring buffer size in screenshot_manager.py",
          "service": "main",
          "files_to_modify": [
            "src/screenshot_manager.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'maxlen.*buffer_seconds\\|deque' src/screenshot_manager.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/screenshot_manager.py with ScreenshotManager class. Implements optimized ring buffer using collections.deque with dynamic maxlen calculated from fps * buffer_seconds. Includes methods for adding frames, retrieving frames from N seconds ago, and buffer management. Verification passes successfully. Commit: 99f8f7d",
          "updated_at": "2026-01-16T13:34:24.921611+00:00"
        },
        {
          "id": "subtask-2-2",
          "description": "Optimize JPEG compression quality in utils.py",
          "service": "main",
          "files_to_modify": [
            "src/utils.py",
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'quality.*[0-9]' src/utils.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Optimized JPEG compression quality in utils.py. Lowered storage quality from 85 to 75 (memory optimization). Added llm_quality config (85) for LLM vision analysis. Updated encode_frame_to_bytes default to 75, kept encode_frame_to_base64 at 85. Verification passes. Commit: 48bd2d4",
          "updated_at": "2026-01-16T13:35:46.407493+00:00"
        },
        {
          "id": "subtask-2-3",
          "description": "Add frame resizing for YOLO processing",
          "service": "main",
          "files_to_modify": [
            "src/yolo_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'cv2.resize\\|resize_for_inference' src/yolo_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/yolo_detector.py with resize_for_inference() function that resizes frames to max 640x640 for YOLO inference (yolov8n native size). Uses cv2.resize() with INTER_LINEAR for optimal quality/speed balance. Maintains aspect ratio and returns scale factors for mapping detections back to original frame size. Also added scale_detections() helper function. Follows code patterns from utils.py with type hints and comprehensive docstrings. Verification passes. Commit: 7101218",
          "updated_at": "2026-01-16T13:36:56.570309+00:00"
        },
        {
          "id": "subtask-2-4",
          "description": "Implement numpy array reuse in motion_detector.py",
          "service": "main",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'preallocate\\|reuse\\|np.zeros_like' src/motion_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/motion_detector.py with MotionDetector class. Implements pre-allocated numpy arrays (_gray_frame, _fg_mask, _thresh, _blur) that are reused across frames using cv2 functions with dst parameter. Background subtractor with configurable sensitivity. Includes detect(), reset(), get_debug_frame() methods and memory_usage_bytes property. Verification passes successfully. Commit: 78be3f6",
          "updated_at": "2026-01-16T13:38:40.475998+00:00"
        }
      ]
    },
    {
      "id": "phase-3-cpu",
      "name": "CPU Optimization",
      "type": "implementation",
      "description": "Optimize CPU usage: multi-threading, frame skip on high load, lazy initialization",
      "depends_on": [
        "phase-1-measure"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-3-1",
          "description": "Implement frame skip mechanism in motion_detector.py",
          "service": "main",
          "files_to_modify": [
            "src/motion_detector.py",
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'frame_skip\\|skip_count\\|high_load' src/motion_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Implemented frame skip mechanism in motion_detector.py. Added frame_skip_threshold config (default 70%), psutil CPU monitoring, should_skip_frame() method checking CPU and queue size, updated detect() to skip frames during high load, added skip counters and skip_stats property. Verification passes. Commit: 5299be4",
          "updated_at": "2026-01-16T13:40:46.939642+00:00"
        },
        {
          "id": "subtask-3-2",
          "description": "Add lazy initialization for YOLO model",
          "service": "main",
          "files_to_modify": [
            "src/yolo_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q '_model.*None\\|_lazy_load\\|@property' src/yolo_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created YOLODetector class with lazy initialization. Model is initialized as _model = None in __init__ and loaded on first access via @property pattern. Added _lazy_load_model() method that loads ultralytics YOLO model on first detect() call. Includes proper error handling, logging, and follows patterns from llm_analyzer.py. Verification passes. Commit: b0ebbeb",
          "updated_at": "2026-01-16T13:42:15.274326+00:00"
        },
        {
          "id": "subtask-3-3",
          "description": "Optimize YOLO batch inference",
          "service": "main",
          "files_to_modify": [
            "src/yolo_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'batch\\|stream.*True\\|verbose.*False' src/yolo_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added detect_batch() method for processing multiple frames efficiently. Enhanced detect() method with stream=True for memory-efficient batch processing and verbose=False to disable unnecessary logging. Batch processing improves throughput when queue builds up by reducing per-frame overhead. Verification passes. Commit: be1a088",
          "updated_at": "2026-01-16T13:43:29.313850+00:00"
        },
        {
          "id": "subtask-3-4",
          "description": "Add threading for camera capture",
          "service": "main",
          "files_to_modify": [
            "src/motion_detector.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'threading.Thread\\|queue.Queue\\|_capture_thread' src/motion_detector.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added threading support for camera capture with queue.Queue for thread-safe frame communication. Implemented start_capture_thread(), stop_capture_thread(), _capture_worker(), get_frame(), and properties for queue_size and is_capturing. Includes proper error handling, logging, and graceful shutdown.",
          "updated_at": "2026-01-16T13:44:42.609638+00:00"
        }
      ]
    },
    {
      "id": "phase-4-network",
      "name": "Network Optimization",
      "type": "implementation",
      "description": "Optimize network usage: MQTT batching, Telegram rate limiting, OpenAI caching, connection keep-alive",
      "depends_on": [
        "phase-1-measure"
      ],
      "parallel_safe": true,
      "subtasks": [
        {
          "id": "subtask-4-1",
          "description": "Implement LLM response caching in llm_analyzer.py",
          "service": "main",
          "files_to_modify": [
            "src/llm_analyzer.py",
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/llm_analyzer.py",
            "src/utils.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'cache\\|hashlib\\|_cache_key\\|functools.lru_cache' src/llm_analyzer.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Implemented LLM response caching with SHA256-based cache keys, LRU eviction policy using OrderedDict, and configurable cache size. Added cache configuration options to LLMConfig with environment variable support. Verification passed successfully.",
          "updated_at": "2026-01-16T13:46:39.375550+00:00"
        },
        {
          "id": "subtask-4-2",
          "description": "Add MQTT message batching in mqtt_client.py",
          "service": "main",
          "files_to_modify": [
            "src/mqtt_client.py",
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/mqtt_client.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'batch\\|_message_queue\\|asyncio.Queue' src/mqtt_client.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Successfully implemented MQTT message batching with asyncio.Queue. Added configuration for batch_enabled, batch_size, and batch_interval. Created _batch_publish_loop() for processing queued messages, and updated publish_motion() and publish_state() methods to use batching when enabled. All verification checks passed.",
          "updated_at": "2026-01-16T13:48:54.415489+00:00"
        },
        {
          "id": "subtask-4-3",
          "description": "Enhance Telegram rate limiting in telegram_bot.py",
          "service": "main",
          "files_to_modify": [
            "src/telegram_bot.py",
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/utils.py",
            "src/telegram_bot.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'RateLimiter\\|rate_limit_seconds\\|_rate_limiter' src/telegram_bot.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Enhanced Telegram rate limiting by adding _message_rate_limiter to prevent message spam. Applied rate limiting to send_message method using async context manager pattern. Verification passed successfully.",
          "updated_at": "2026-01-16T13:50:00.677544+00:00"
        },
        {
          "id": "subtask-4-4",
          "description": "Add connection keep-alive for OpenAI client",
          "service": "main",
          "files_to_modify": [
            "src/llm_analyzer.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'http_client\\|httpx\\|max_connections\\|keepalive' src/llm_analyzer.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added httpx connection pooling with keep-alive for OpenAI client. Configured max_connections=10, max_keepalive_connections=5, keepalive_expiry=30.0. Also added close() method for proper resource cleanup.",
          "updated_at": "2026-01-16T13:51:13.816948+00:00"
        }
      ]
    },
    {
      "id": "phase-5-integration",
      "name": "Integration & Validation",
      "type": "integration",
      "description": "Integrate all optimizations, run 24h stability test, verify performance targets",
      "depends_on": [
        "phase-2-memory",
        "phase-3-cpu",
        "phase-4-network"
      ],
      "parallel_safe": false,
      "subtasks": [
        {
          "id": "subtask-5-1",
          "description": "Update main application to use metrics collector",
          "service": "main",
          "all_services": false,
          "files_to_modify": [
            "src/main.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/metrics.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'MetricsCollector\\|metrics.collect' src/main.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created src/main.py with SmartMotionDetector class. Integrated MetricsCollector for performance monitoring, HealthEndpoint for metrics exposure, periodic metrics logging every 30s, and frame recording for FPS tracking. Verification passes. Commit: 6d3de70",
          "updated_at": "2026-01-16T13:52:39.118957+00:00"
        },
        {
          "id": "subtask-5-2",
          "description": "Add optimization configuration to config.py",
          "service": "main",
          "all_services": false,
          "files_to_modify": [
            "src/config.py"
          ],
          "files_to_create": [],
          "patterns_from": [
            "src/config.py"
          ],
          "verification": {
            "type": "command",
            "command": "grep -q 'OptimizationConfig\\|frame_skip_threshold\\|cache_enabled' src/config.py && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Added OptimizationConfig dataclass with enabled, cpu_monitoring, memory_monitoring, and metrics_interval fields. Integrated into main Config class with environment variable loading. Verification passed.",
          "updated_at": "2026-01-16T13:53:46.053297+00:00"
        },
        {
          "id": "subtask-5-3",
          "description": "Create 24-hour stability test script",
          "service": "main",
          "all_services": false,
          "files_to_modify": [],
          "files_to_create": [
            "tests/test_stability_24h.py"
          ],
          "patterns_from": [
            "tests/test_llm_analyzer.py"
          ],
          "verification": {
            "type": "command",
            "command": "python -m pytest tests/test_stability_24h.py --co && echo 'OK' || echo 'FAIL'",
            "expected": "OK"
          },
          "status": "completed",
          "notes": "Created comprehensive 24-hour stability test suite with MemoryMonitor (tracemalloc, psutil) and CPUMonitor classes. Implemented 4 test methods: test_motion_detector_stability, test_screenshot_manager_stability, test_metrics_collector_stability, and test_integrated_system_stability. Tests verify memory leak detection (< 10MB increase), performance targets (FPS >= 5, Memory < 512MB, CPU < 50%), and system stability. Configurable duration via --duration flag (default 60s for CI, 86400s for full 24h test). Marked with @pytest.mark.slow. Detailed progress output and comprehensive statistics reporting. Verification: Python syntax valid, 4 test methods found, all required imports present. Commit: e2839f8",
          "updated_at": "2026-01-16T13:57:08.715898+00:00"
        },
        {
          "id": "subtask-5-4",
          "description": "Verify performance targets met",
          "service": "main",
          "all_services": true,
          "files_to_modify": [],
          "files_to_create": [],
          "patterns_from": [],
          "verification": {
            "type": "e2e",
            "steps": [
              "Run application with optimizations enabled",
              "Trigger multiple motion events",
              "Check metrics endpoint: FPS >= 5, Memory < 512MB, CPU < 50%",
              "Verify YOLO inference < 500ms, LLM response < 10s",
              "Run for 1 hour minimum, check for memory leaks"
            ]
          },
          "status": "pending",
          "notes": "Manual verification of all performance targets. Document results in OPTIMIZATION_RESULTS.md"
        }
      ]
    }
  ],
  "summary": {
    "total_phases": 5,
    "total_subtasks": 18,
    "services_involved": [
      "main"
    ],
    "performance_targets": {
      "fps": ">=5",
      "memory_mb": "<512",
      "cpu_percent": "<50",
      "yolo_inference_ms": "<500",
      "llm_response_s": "<10"
    },
    "parallelism": {
      "max_parallel_phases": 3,
      "parallel_groups": [
        {
          "phases": [
            "phase-2-memory",
            "phase-3-cpu",
            "phase-4-network"
          ],
          "reason": "All depend only on phase-1-measure, optimize different subsystems with no file conflicts"
        }
      ],
      "recommended_workers": 3,
      "speedup_estimate": "2x faster than sequential (phases 2-4 in parallel)"
    },
    "startup_command": "source auto-claude/.venv/bin/activate && python auto-claude/run.py --spec 13 --parallel 3"
  },
  "verification_strategy": {
    "risk_level": "high",
    "skip_validation": false,
    "test_creation_phase": "post_implementation",
    "test_types_required": [
      "unit",
      "integration",
      "performance"
    ],
    "security_scanning_required": false,
    "staging_deployment_required": false,
    "acceptance_criteria": [
      "All existing tests pass",
      "24-hour stability test passes",
      "No memory leaks detected (tracemalloc verification)",
      "All performance targets met (FPS, Memory, CPU, inference times)",
      "Health metrics endpoint returns valid data"
    ],
    "verification_steps": [
      {
        "name": "Unit Tests",
        "command": "pytest tests/ -v --ignore=tests/test_stability_24h.py",
        "expected_outcome": "All tests pass",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Integration Tests",
        "command": "pytest tests/e2e_telegram_bot.py -v",
        "expected_outcome": "E2E test passes",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "Memory Profiling",
        "command": "python -m memory_profiler src/main.py",
        "expected_outcome": "Memory usage stays below 512MB",
        "type": "test",
        "required": true,
        "blocking": true
      },
      {
        "name": "CPU Profiling",
        "command": "python -m cProfile -o profile.stats src/main.py",
        "expected_outcome": "Identify and optimize hotspots",
        "type": "test",
        "required": true,
        "blocking": false
      },
      {
        "name": "24-Hour Stability Test",
        "command": "pytest tests/test_stability_24h.py -v -s",
        "expected_outcome": "No memory leaks, stable performance over 24h",
        "type": "test",
        "required": true,
        "blocking": true
      }
    ],
    "reasoning": "High risk because performance changes can introduce subtle bugs or regressions. Requires extensive testing including 24h stability and memory profiling to ensure no leaks."
  },
  "qa_acceptance": {
    "unit_tests": {
      "required": true,
      "commands": [
        "pytest tests/ -v --ignore=tests/test_stability_24h.py"
      ],
      "minimum_coverage": null
    },
    "integration_tests": {
      "required": true,
      "commands": [
        "pytest tests/e2e_telegram_bot.py -v"
      ],
      "services_to_test": [
        "main"
      ]
    },
    "e2e_tests": {
      "required": false,
      "commands": [],
      "flows": []
    },
    "browser_verification": {
      "required": false,
      "pages": []
    },
    "database_verification": {
      "required": false,
      "checks": []
    },
    "performance_tests": {
      "required": true,
      "commands": [
        "pytest tests/test_stability_24h.py -v"
      ],
      "metrics_to_verify": [
        "fps >= 5",
        "memory < 512MB",
        "cpu < 50%",
        "yolo_inference < 500ms",
        "llm_response < 10s"
      ]
    },
    "memory_profiling": {
      "required": true,
      "tool": "tracemalloc",
      "duration_hours": 24,
      "leak_threshold": "10MB increase over 24h"
    }
  },
  "qa_signoff": null,
  "status": "in_progress",
  "planStatus": "in_progress",
  "updated_at": "2026-01-16T13:57:29.341Z",
  "last_updated": "2026-01-16T13:57:08.715909+00:00"
}